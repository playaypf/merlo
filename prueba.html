<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilla YPF - Web</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #444; 
            margin: 10px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }

        /* Contenedor principal con scroll horizontal suave para m√≥viles */
        .hoja { 
            width: 100%; 
            max-width: 1050px; 
            background: white; 
            padding: 10px; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5); 
            margin-bottom: 20px;
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
        }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        
        /* Celdas m√°s altas y letras m√°s grandes para usar con los dedos */
        td { 
            border: 1px solid #000; 
            height: 35px; 
            font-size: 13px; 
            vertical-align: middle; 
            padding: 0; 
        }
        
        .flex-row { display: flex; align-items: center; width: 100%; height: 100%; }
        .label-text { padding: 0 5px; font-weight: bold; white-space: nowrap; font-size: 10px; }
        .currency { padding-left: 5px; font-weight: bold; color: #555; transition: color 0.3s;}
        
        /* Inputs adaptados para visi√≥n y tacto */
        input, select, textarea { 
            border: none; 
            outline: none; 
            font-size: 14px; 
            width: 100%; 
            height: 100%; 
            min-height: 35px;
            background: transparent; 
            padding: 0 5px; 
            box-sizing: border-box; 
            font-family: inherit;
        }
        input:focus { background-color: #e8f4fd; }
        
        .header-bg { background-color: #f2f2f2; text-align: center; font-weight: bold; text-transform: uppercase; }
        .readonly-calc { background-color: #fdfdfd; font-weight: bold; color: #000; }
        .sub-header { text-align: center; font-weight: bold; font-size: 9px; background: #fafafa; }
        
        .c-nombre { width: 16.5%; } .c-importe { width: 8.5%; } .c-rend-label { width: 15%; } .c-rend-monto { width: 10%; }
        #obs { resize: none; min-height: 45px; line-height: 1.4; padding-top: 5px;}

        /* Panel de control flexible */
        .panel-control { 
            width: 100%; 
            max-width: 1050px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: #fff; 
            padding: 15px 20px; 
            box-sizing: border-box; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5); 
            border-radius: 5px; 
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .btn { padding: 10px 20px; font-weight: bold; cursor: pointer; border: none; border-radius: 4px; color: white; font-size: 14px;}
        .btn-guardar { background-color: #1976d2; } .btn-guardar:hover { background-color: #115293; }
        .btn-cargar { background-color: #2e7d32; } .btn-cargar:hover { background-color: #1b5e20; }
        #status-msg { font-size: 14px; font-weight: bold; color: #555; }

        /* REGLAS EXCLUSIVAS PARA PANTALLAS CHICAS (CELULARES) */
        @media (max-width: 768px) {
            table { min-width: 800px; } /* Evita que la tabla se deforme */
            .panel-control { flex-direction: column; text-align: center; }
            .btn { width: 100%; padding: 15px; font-size: 16px; }
            .label-text { font-size: 11px; white-space: normal; } 
        }
    </style>
</head>
<body>

<div class="hoja">
    <table id="planilla">
        <colgroup>
            <col class="c-nombre"><col class="c-importe">
            <col class="c-nombre"><col class="c-importe">
            <col class="c-nombre"><col class="c-importe">
            <col class="c-rend-label"><col class="c-rend-monto">
        </colgroup>

        <tr>
            <td colspan="6" class="header-bg" style="font-size: 14px;">PLANILLA DE CONTROL DE TURNO PLAYA YPF</td>
            <td colspan="2"><div class="flex-row"><span class="label-text">PLANILLA N¬∞</span><input type="text"></div></td>
        </tr>
        <tr>
            <td colspan="2"><div class="flex-row"><span class="label-text">Resp. Playa:</span><input type="text"></div></td>
            <td colspan="2"><div class="flex-row"><span class="label-text">Operarios:</span><input type="text"></div></td>
            <td colspan="2"><div class="flex-row"><span class="label-text">Fecha:</span><input type="date" id="input-fecha"></div></td>
            <td colspan="2">
                <div class="flex-row"><span class="label-text">TURNO:</span>
                    <select id="input-turno"><option></option><option>MA√ëANA</option><option>TARDE</option><option>NOCHE</option></select>
                </div>
            </td>
        </tr>

        <tr><td colspan="6" class="header-bg">BUZONES</td><td colspan="2" class="header-bg">RENDICION</td></tr>
        <tr>
            <td><input type="text" inputmode="decimal" class="sum-buzon"></td><td><input type="text" inputmode="decimal" class="sum-buzon"></td>
            <td><input type="text" inputmode="decimal" class="sum-buzon"></td><td><input type="text" inputmode="decimal" class="sum-buzon"></td>
            <td><input type="text" inputmode="decimal" class="sum-buzon"></td><td><input type="text" inputmode="decimal" class="sum-buzon"></td>
            <td class="label-text">TOTAL COMB (VENTA)</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" id="venta-combustible" class="val-cambio"></div></td>
        </tr>
        <tr>
            <td><input type="text" inputmode="decimal" class="sum-buzon"></td><td><input type="text" inputmode="decimal" class="sum-buzon"></td>
            <td><input type="text" inputmode="decimal" class="sum-buzon"></td><td><input type="text" inputmode="decimal" class="sum-buzon"></td>
            <td><input type="text" inputmode="decimal" class="sum-buzon"></td><td><input type="text" inputmode="decimal" class="sum-buzon"></td>
            <td class="label-text">T. LUBRICANTES (VENTA)</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" id="out-lubricantes-rend" class="readonly-calc" readonly></div></td>
        </tr>

        <tr>
            <td colspan="4" class="header-bg">DETALLE CUENTAS CORRIENTES Y YER</td>
            <td colspan="2" class="header-bg">VENTA DE LUBRICANTES</td>
            <td class="header-bg">TOTAL 1 (ESPERADO)</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" id="total-esperado" class="readonly-calc" readonly></div></td>
        </tr>
        <tr>
            <td class="sub-header">NOMBRE</td><td class="sub-header">IMPORTE</td>
            <td class="sub-header">NOMBRE</td><td class="sub-header">IMPORTE</td>
            <td class="sub-header">NOMBRE</td><td class="sub-header">IMPORTE</td>
            <td class="sub-header">CONCEPTO</td><td class="sub-header">IMPORTE RENDIDO</td>
        </tr>

        <tr>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-lubri"></div></td>
            <td class="label-text">BUZONES (RECAUDADO)</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" id="out-buzones-rend" class="readonly-calc" readonly></div></td>
        </tr>
        <tr>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-lubri"></div></td>
            <td class="label-text">CTA. CTE</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" id="out-ctacte-rend" class="readonly-calc" readonly></div></td>
        </tr>
        <tr>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-lubri"></div></td>
            <td class="label-text">TARJETAS</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-rend-manual"></div></td>
        </tr>
        <tr>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-lubri"></div></td>
            <td class="label-text">MERCADO PAGO</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-rend-manual"></div></td>
        </tr>
        <tr>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-lubri"></div></td>
            <td class="label-text">APP YPF</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-rend-manual"></div></td>
        </tr>
        <tr>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-lubri"></div></td>
            <td class="label-text">DESC. APP YPF</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-rend-manual"></div></td>
        </tr>
        <tr>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-lubri"></div></td>
            <td class="label-text">PAGOS GASTOS</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-rend-manual"></div></td>
        </tr>
        <tr>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-lubri"></div></td>
            <td class="label-text">ULTIMO BUZON</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-rend-manual"></div></td>
        </tr>
        
        <tr>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-ctacte"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-lubri"></div></td>
            <td><input type="text"></td><td><div class="flex-row"><span class="currency">$</span><input type="text" inputmode="decimal" class="sum-rend-manual"></div></td>
        </tr>

        <tr>
            <td colspan="6" rowspan="2" style="padding: 5px; vertical-align: top;">
                <span class="label-text">FIRMA / OBSERVACIONES</span>
                <textarea id="obs" placeholder="Escribe aqu√≠..."></textarea>
            </td>
            <td class="header-bg">TOTAL 2 (RENDIDO)</td>
            <td><div class="flex-row"><span class="currency">$</span><input type="text" id="total-rendido" class="readonly-calc" readonly></div></td>
        </tr>
        <tr>
            <td class="header-bg" id="label-diferencia">DIFERENCIA</td>
            <td><div class="flex-row"><span class="currency" id="curr-diferencia">$</span><input type="text" id="diferencia" class="readonly-calc" readonly></div></td>
        </tr>
    </table>
</div>

<div class="panel-control">
    <button class="btn btn-cargar" onclick="cargarPlanilla()">üì• Buscar y Cargar Datos</button>
    <span id="status-msg">Selecciona Fecha y Turno arriba para operar</span>
    <button class="btn btn-guardar" onclick="guardarPlanilla()">üíæ Guardar Planilla</button>
</div>

<script>
    // ----------------------------------------------------
    // ‚ö†Ô∏è PEGA AQU√ç TU URL DE GOOGLE APPS SCRIPT
    // ----------------------------------------------------
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzRPLgBjVLjUlVD4RdsZiEkoQkdWsQi3KhXQ3z9Ayw555i-xN2nvOyljqoLZ6-IebiYSQ/exec';

    const planilla = document.getElementById('planilla');

    function esCampoNumerico(el) {
        return el.classList.contains('sum-buzon') || el.classList.contains('sum-ctacte') || el.classList.contains('sum-lubri') || el.classList.contains('sum-rend-manual') || el.id === 'venta-combustible';
    }

    function parseCurrency(val) {
        if (!val) return 0;
        let str = val.toString().trim();
        if (str.includes(',')) str = str.replace(/\./g, '').replace(',', '.');
        str = str.replace(/[^0-9.-]/g, '');
        let num = parseFloat(str);
        return isNaN(num) ? 0 : num;
    }

    function formatOutput(num) {
        if (num === 0) return ''; 
        return new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
    }

    planilla.addEventListener('focusin', function(e) {
        if (e.target.tagName === 'INPUT' && !e.target.readOnly && esCampoNumerico(e.target)) {
            let val = parseCurrency(e.target.value);
            e.target.value = val === 0 ? '' : val; 
        }
    });

    planilla.addEventListener('focusout', function(e) {
        if (e.target.tagName === 'INPUT' && !e.target.readOnly && esCampoNumerico(e.target)) {
            let val = parseCurrency(e.target.value);
            e.target.value = formatOutput(val);
        }
    });

    function calcular() {
        let sumBuzones = 0, sumLubri = 0, sumCtaCte = 0, sumManuales = 0;
        document.querySelectorAll('.sum-buzon').forEach(i => sumBuzones += parseCurrency(i.value));
        document.querySelectorAll('.sum-lubri').forEach(i => sumLubri += parseCurrency(i.value));
        document.querySelectorAll('.sum-ctacte').forEach(i => sumCtaCte += parseCurrency(i.value));
        document.querySelectorAll('.sum-rend-manual').forEach(i => sumManuales += parseCurrency(i.value));

        document.getElementById('out-buzones-rend').value = formatOutput(sumBuzones);
        document.getElementById('out-lubricantes-rend').value = formatOutput(sumLubri);
        document.getElementById('out-ctacte-rend').value = formatOutput(sumCtaCte);

        let vtaComb = parseCurrency(document.getElementById('venta-combustible').value);
        let tEsperado = vtaComb + sumLubri;
        document.getElementById('total-esperado').value = formatOutput(tEsperado);

        let tRendido = sumBuzones + sumCtaCte + sumManuales;
        document.getElementById('total-rendido').value = formatOutput(tRendido);

        let dif = tRendido - tEsperado;
        let diffInput = document.getElementById('diferencia');
        let diffLabel = document.getElementById('label-diferencia');
        let diffCurr = document.getElementById('curr-diferencia');
        
        diffInput.value = formatOutput(dif);

        if (dif < 0) { diffInput.style.color = '#d32f2f'; diffLabel.style.color = '#d32f2f'; diffCurr.style.color  = '#d32f2f'; }
        else if (dif > 0) { diffInput.style.color = '#2e7d32'; diffLabel.style.color = '#2e7d32'; diffCurr.style.color  = '#2e7d32'; } 
        else { diffInput.style.color = '#000'; diffLabel.style.color = '#000'; diffCurr.style.color  = '#555'; }
    }

    planilla.addEventListener('input', calcular);

    const textarea = document.getElementById('obs');
    textarea.addEventListener('focus', function() { if (this.value.trim() === '') this.value = '‚Ä¢ '; });
    textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const start = this.selectionStart;
            this.value = this.value.substring(0, start) + '\n‚Ä¢ ' + this.value.substring(this.selectionEnd);
            this.selectionStart = this.selectionEnd = start + 3;
        }
    });

    calcular();

   // ==========================================
    // L√ìGICA DE GUARDADO Y CARGA (WEB)
    // ==========================================

    function msg(texto, color) {
        const el = document.getElementById('status-msg');
        el.textContent = texto;
        el.style.color = color;
    }

    function getValoresCeldas() {
        const inputs = document.querySelectorAll('input:not([readonly]), select, textarea');
        return Array.from(inputs).map(el => el.value);
    }

    function setValoresCeldas(dataArray) {
        const inputs = document.querySelectorAll('input:not([readonly]), select, textarea');
        inputs.forEach((el, index) => {
            if (dataArray[index] !== undefined) el.value = dataArray[index];
        });
        calcular(); // Recalculamos totales al cargar
    }

    // Funci√≥n para dejar todo en blanco
    function limpiarPlanilla() {
        const inputs = document.querySelectorAll('input:not([readonly]), select, textarea');
        inputs.forEach(el => {
            el.value = ''; // Vaciamos todas las celdas
        });
        calcular(); // Devuelve los totales a $0.00
        msg('‚ú® Guardado exitoso. Planilla en blanco para nuevo turno.', 'green');
    }

    function guardarPlanilla() {
        const fecha = document.getElementById('input-fecha').value;
        const turno = document.getElementById('input-turno').value;

        if (!fecha || !turno) {
            msg('‚ö†Ô∏è Falta ingresar Fecha y Turno', 'red');
            return;
        }

        msg('‚è≥ Guardando...', 'blue');
        
        const payload = {
            fecha: fecha,
            turno: turno,
            datos: getValoresCeldas()
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(payload),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'ok') {
                limpiarPlanilla(); // <-- Se ejecuta al guardar con √©xito
            } else {
                msg('‚ùå Error al guardar', 'red');
            }
        })
        .catch(error => msg('‚ùå Error de conexi√≥n', 'red'));
    }

    function cargarPlanilla() {
        const fecha = document.getElementById('input-fecha').value;
        const turno = document.getElementById('input-turno').value;

        if (!fecha || !turno) {
            msg('‚ö†Ô∏è Pon Fecha y Turno para buscar', 'red');
            return;
        }

        msg('‚è≥ Buscando datos...', 'blue');

        // encodeURIComponent(turno) evita que la "√ë" de "MA√ëANA" rompa la b√∫squeda
        fetch(`${SCRIPT_URL}?fecha=${fecha}&turno=${encodeURIComponent(turno)}`)
        .then(response => response.json())
        .then(data => {
            if(data.status === 'ok') {
                setValoresCeldas(data.datos);
                msg('‚úÖ Datos cargados listos para editar', 'green');
            } else {
                msg('‚ÑπÔ∏è No hay datos para esa Fecha/Turno', 'orange');
            }
        })
        .catch(error => msg('‚ùå Error de conexi√≥n al buscar', 'red'));
    }

</script>

</body>
</html>
